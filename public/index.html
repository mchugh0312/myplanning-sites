<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Loading...</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--primary:#2c3e50;--accent:#e74c3c}
html,body{height:100%;overflow-x:hidden;font-family:'Playfair Display',serif}
body{display:flex;flex-direction:column}

/* Navigation */
.nav-top{position:fixed;top:0;left:0;right:0;z-index:1000;background:rgba(255,255,255,.98);box-shadow:0 2px 15px rgba(0,0,0,.1)}
.nav-container{max-width:1200px;margin:0 auto;padding:0 2rem;display:flex;justify-content:space-between;align-items:center;height:70px}
.logo{font-size:1.5rem;font-weight:700;color:var(--primary);cursor:pointer}
.nav-links{display:flex;gap:2rem;list-style:none}
.nav-link{font-weight:500;color:#333;padding:.5rem 1rem;cursor:pointer;transition:color .3s}
.nav-link:hover,.nav-link.active{color:var(--primary)}
.mobile-toggle{display:none;background:none;border:none;font-size:1.5rem;cursor:pointer}

/* Content */
#app{flex:1;margin-top:70px;overflow-y:auto}
.section{padding:5rem 2rem;max-width:1200px;margin:0 auto}

/* Hero */
.hero-bg{background-size:cover;background-position:center;position:relative;min-height:calc(100vh - 70px);display:flex;align-items:center;justify-content:center}
.hero-bg::before{content:'';position:absolute;inset:0;background:linear-gradient(rgba(0,0,0,.3),rgba(0,0,0,.5));z-index:1}
.hero-content{position:relative;z-index:10;text-align:center;padding:2rem;color:#fff}

/* Loading */
.loading{display:flex;align-items:center;justify-content:center;min-height:100vh}
.spinner{border:4px solid #f3f3f3;border-top:4px solid #333;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 1rem}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}

/* Password Modal */
.password-modal{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:9999}
.password-box{background:#fff;padding:3rem;border-radius:12px;max-width:400px;width:90%;box-shadow:0 10px 40px rgba(0,0,0,0.3)}
.password-box h2{margin:0 0 1rem;font-size:1.5rem}
.password-box input{width:100%;padding:1rem;border:1px solid #ddd;border-radius:8px;font-size:1rem;margin:1rem 0;box-sizing:border-box}
.password-box button{width:100%;padding:1rem;background:#2c3e50;color:#fff;border:none;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer}
.error-msg{color:#e74c3c;font-size:0.9rem;display:none}

/* Cards */
.event-card{background:#fff;border-radius:12px;padding:2rem;box-shadow:0 2px 10px rgba(0,0,0,.08);margin-bottom:2rem}
.gallery-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1rem}
.gallery-item{aspect-ratio:1;overflow:hidden;border-radius:12px}
.gallery-item img{width:100%;height:100%;object-fit:cover}

@media (max-width:768px){
.nav-links{display:none;flex-direction:column;position:absolute;top:70px;left:0;right:0;background:#fff;padding:1rem;box-shadow:0 2px 10px rgba(0,0,0,.1)}
.nav-links.open{display:flex}
.mobile-toggle{display:block}
}
</style>
</head>
<body>

<nav class="nav-top" id="nav" style="display:none">
<div class="nav-container">
<span class="logo" id="logo" onclick="navigateTo('home')">Loading...</span>
<ul class="nav-links" id="nav-menu"></ul>
<button class="mobile-toggle" onclick="toggleMobile()">‚ò∞</button>
</div>
</nav>

<div id="app">
<div class="loading">
<div style="text-align:center">
<div class="spinner"></div>
<p>Loading...</p>
</div>
</div>
</div>

<script>
const API='https://wedding-recommender.onrender.com';
const path=window.location.pathname.split('/').filter(p=>p);
const slug=path[0]||'test-wedding';
let currentPage=path[1]||'home';
let weddingData=null;

console.log('üöÄ App started - slug:', slug, 'page:', currentPage);

function toggleMobile(){
document.getElementById('nav-menu').classList.toggle('open');
}

function fmt(d){
if(!d)return'';
try{
return new Date(d).toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
}catch(e){return d}
}

// Pages
const renderHome=d=>`
<section class="hero-bg" style="background-image:url(${d.hero_image||'https://images.unsplash.com/photo-1519741497674-611481863552?w=1200'})">
<div class="hero-content">
<h1 style="font-size:clamp(3rem,8vw,6rem);margin-bottom:2rem">${d.couple_names}</h1>
<p style="font-size:1.5rem;margin-bottom:1rem">${fmt(d.wedding_date)}</p>
<p style="font-size:1.2rem">${d.wedding_location||''}</p>
</div>
</section>`;

const renderStory=d=>`
<div class="section" style="padding-top:2rem">
<h2 style="font-size:3rem;text-align:center;color:var(--primary);margin-bottom:2rem">Our Story</h2>
<p style="font-size:1.2rem;line-height:1.8;text-align:center;max-width:800px;margin:0 auto;white-space:pre-line">${d.story||'Our love story will be shared soon...'}</p>
</div>`;

const renderEvents=d=>{
const events=d.events||[];
if(!events.length)return`<div class="section"><p style="text-align:center">Details coming soon</p></div>`;
return`<div class="section" style="background:#f9f9f9">
<h2 style="font-size:3rem;text-align:center;color:var(--primary);margin-bottom:3rem">Events</h2>
${events.map(e=>`
<div class="event-card">
<h3 style="color:var(--primary);margin-bottom:1rem">${e.name||'Event'}</h3>
${e.date?`<p><strong>Date:</strong> ${fmt(e.date)} ${e.time||''}</p>`:''}
${e.venue?`<p><strong>Venue:</strong> ${e.venue}</p>`:''}
${e.dress_code?`<p><strong>Dress Code:</strong> ${e.dress_code}</p>`:''}
${e.description?`<p style="margin-top:1rem">${e.description}</p>`:''}
</div>
`).join('')}
</div>`;
};

const renderTravel=d=>`
<div class="section">
<h2 style="font-size:3rem;text-align:center;color:var(--primary);margin-bottom:3rem">Travel & Stay</h2>
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:2rem">
<div class="event-card">
<h3 style="color:var(--primary);margin-bottom:1rem">Getting There</h3>
<p style="white-space:pre-line">${d.travel_info||'Details coming soon...'}</p>
</div>
<div class="event-card">
<h3 style="color:var(--primary);margin-bottom:1rem">Where to Stay</h3>
<p style="white-space:pre-line">${d.accommodation_info||'Details coming soon...'}</p>
</div>
</div>
</div>`;

const renderThingsToDo=d=>`
<div class="section" style="background:#f9f9f9">
<h2 style="font-size:3rem;text-align:center;color:var(--primary);margin-bottom:3rem">Things to Do</h2>
<p style="font-size:1.1rem;line-height:1.8;max-width:800px;margin:0 auto;white-space:pre-line">${d.things_to_do||'Information coming soon...'}</p>
</div>`;

const renderGallery=d=>{
const imgs=(d.gallery_images||[]).map(i=>i.url||i.thumbnail).filter(Boolean);
if(!imgs.length)return`<div class="section"><p style="text-align:center">Photos coming soon</p></div>`;
return`<div class="section" style="background:#f9f9f9">
<h2 style="font-size:3rem;text-align:center;color:var(--primary);margin-bottom:3rem">Gallery</h2>
<div class="gallery-grid">${imgs.map(u=>`<div class="gallery-item"><img src="${u}" alt=""></div>`).join('')}</div>
</div>`;
};

const renderRSVP=d=>`
<div class="section">
<h2 style="font-size:3rem;text-align:center;color:var(--primary);margin-bottom:3rem">RSVP</h2>
<div style="max-width:600px;margin:0 auto;background:#fff;padding:2rem;border-radius:12px;box-shadow:0 2px 20px rgba(0,0,0,.1)">
<input type="text" placeholder="Your Name *" style="width:100%;padding:1rem;border:1px solid #ddd;border-radius:8px;margin-bottom:1rem">
<input type="email" placeholder="Email *" style="width:100%;padding:1rem;border:1px solid #ddd;border-radius:8px;margin-bottom:1rem">
<button onclick="alert('Thank you!')" style="width:100%;padding:1rem;background:var(--primary);color:#fff;border:none;border-radius:8px;font-size:1.1rem;font-weight:600;cursor:pointer">Submit RSVP</button>
</div>
</div>`;

const pages={
home:renderHome,
story:renderStory,
events:renderEvents,
travel:renderTravel,
things_to_do:renderThingsToDo,
gallery:renderGallery,
rsvp:renderRSVP
};

function navigateTo(page){
currentPage=page;
const url=page==='home'?`/${slug}`:`/${slug}/${page}`;
history.pushState({page},null,url);
renderPage(page);
updateNav(page);
window.scrollTo(0,0);
console.log('üìç Navigated to:', page);
}

function updateNav(page){
document.querySelectorAll('.nav-link').forEach(link=>{
link.classList.remove('active');
if(link.getAttribute('data-page')===page)link.classList.add('active');
});
}

function renderPage(page){
if(!weddingData){
console.error('‚ùå No wedding data');
return;
}
const renderer=pages[page]||pages.home;
document.getElementById('app').innerHTML=renderer(weddingData);
console.log('‚úÖ Rendered page:', page);
}

function generateNav(data){
const config=data.menu_config||{};
const items=[
{key:'home',label:'Home'},
{key:'story',label:'Our Story'},
{key:'events',label:'Events'},
{key:'travel',label:'Travel'},
{key:'things_to_do',label:'Things to Do'},
{key:'gallery',label:'Gallery'},
{key:'rsvp',label:'RSVP'}
];

const menu=document.getElementById('nav-menu');
menu.innerHTML='';

items.forEach(item=>{
if(config[item.key]===true){
const li=document.createElement('li');
const span=document.createElement('span');
span.className='nav-link';
span.textContent=item.label;
span.setAttribute('data-page',item.key);
span.onclick=()=>navigateTo(item.key);
li.appendChild(span);
menu.appendChild(li);
console.log('‚úÖ Added menu:', item.label);
}else{
console.log('‚äò Skipped menu:', item.label);
}
});
}

function showPasswordModal(pwd){
document.body.innerHTML=`
<div class="password-modal">
<div class="password-box">
<h2>üîí Password Protected</h2>
<p>This wedding website is private.</p>
<input type="password" id="pwd" placeholder="Enter password">
<div class="error-msg" id="error">Incorrect password</div>
<button onclick="checkPwd()">Enter</button>
</div>
</div>`;

window.checkPwd=function(){
const input=document.getElementById('pwd').value;
if(input===pwd){
sessionStorage.setItem('pwd-'+slug,input);
location.reload();
}else{
document.getElementById('error').style.display='block';
}
};

document.getElementById('pwd').onkeypress=e=>{
if(e.key==='Enter')checkPwd();
};
}

async function init(){
try{
console.log('üîÑ Loading wedding data...');
const res=await fetch(`${API}/wedding-site/${slug}`);
if(!res.ok)throw new Error('Not found');
weddingData=await res.json();
console.log('‚úÖ Wedding data loaded:', weddingData);

// Check password
if(weddingData.password_protected && weddingData.password){
const saved=sessionStorage.getItem('pwd-'+slug);
if(saved!==weddingData.password){
console.log('üîí Password required');
showPasswordModal(weddingData.password);
return;
}
}

// Setup page
const p1=(weddingData.partner_1||'').trim();
const p2=(weddingData.partner_2||'').trim();
const initials=p1&&p2?`${p1[0]} & ${p2[0]}`:'Wedding';

console.log('üë§ Partners:', p1, p2);
console.log('üìù Initials:', initials);

document.getElementById('logo').textContent=initials;
document.title=weddingData.couple_names||`${p1} & ${p2}`;

generateNav(weddingData);
document.getElementById('nav').style.display='block';

renderPage(currentPage);
updateNav(currentPage);

}catch(e){
console.error('‚ùå Error:', e);
document.getElementById('app').innerHTML=`<div class="section"><h1 style="color:red">Error: ${e.message}</h1></div>`;
}
}

window.onpopstate=e=>{
if(e.state && e.state.page){
currentPage=e.state.page;
renderPage(currentPage);
updateNav(currentPage);
}
};

init();
</script>
</body>
</html>
